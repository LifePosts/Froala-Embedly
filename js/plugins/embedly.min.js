(function(e){"function"===typeof define&&define.amd?define(["jquery"],e):"object"===typeof module&&module.exports?module.exports=function(h,a){void 0===a&&(a="undefined"!==typeof window?require("jquery"):require("jquery")(h));e(a);return a}:e(jQuery)})(function(e){var h=/^(http|https):\/\/(([a-zA-Z0-9$\-_.+!*'(),;:&=]|%[0-9a-fA-F]{2})+@)?(((25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])(\.(25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])){3})|localhost|([a-zA-Z0-9\-\u00C0-\u017F]+\.)+([a-zA-Z]{2,}))(:[0-9]+)?(\/(([a-zA-Z0-9$\-_.+!*'(),;:@&=]|%[0-9a-fA-F]{2})*(\/([a-zA-Z0-9$\-_.+!*'(),;:@&=]|%[0-9a-fA-F]{2})*)*)?(\?([a-zA-Z0-9$\-_.+!*'(),;:@&=\/?]|%[0-9a-fA-F]{2})*)?(\#([a-zA-Z0-9$\-_.+!*'(),;:@&=\/?]|%[0-9a-fA-F]{2})*)?)?$/;e.extend(e.FroalaEditor.POPUP_TEMPLATES,{"embedly.insert":"[_BUTTONS_][_INPUT_LAYER_]"});e.extend(e.FroalaEditor.DEFAULTS,{embedlyOptions:{},embedlyHelpText:"Paste a URL to generate code"});e.FroalaEditor.PLUGINS.embedly=function(a){function k(){var b=a.popups.get("embedly.insert"),d=b.find("ul.errorlist"),b=b.find('input.fr-link-attr[type="text"][name="href"]');d.hide();d.html("");b.val("").trigger("change")}function g(b){var d=a.popups.get("embedly.insert"),c=d.find("ul.errorlist"),d=d.find('input.fr-link-attr[type="text"][name="href"]');c.html("<li>"+b+"</li>").fadeIn();d.one("keyup",function(){c.fadeOut()})}function m(b){a.events.focus(!0);a.selection.restore();var d=e.trim(b);if(""===d)return g("The URL is invalid. Please enter a valid URL."),!1;d=d.replace(/ /g,"%20");/^https?:\/\//i.test(d)||(d="http://"+d);if(!h.test(d))return g("The URL is invalid. Please enter a valid URL."),!1;b=document.createElement("a");b.href=d;var c=e("#embedly-card-area");0===c.length?(c=e("<div />").appendTo("body"),c.attr("id","embedly-card-area"),c.css("display","none")):c.empty();c.append(b);var f=embedly.card(b);f?(f.on("card.snippet",function(b){b=e(b.snippet);for(var c in a.opts.embedlyOptions)a.opts.embedlyOptions.hasOwnProperty(c)&&b.attr("data-card-"+c,a.opts.embedlyOptions[c]);a.html.insert('<span contenteditable="false" class="fr-embedly embedly-card-area" data-url="'+d+'" data-title="'+b.text()+'">'+b[0].outerHTML+"</span><p><br></p>");c=a.$el.find(".fr-embedly");c.removeClass("fr-embedly");a.popups.hide("embedly.insert");a.events.trigger("embedly.inserted",[c,d,b[0].outerHTML]);return!0}),f.on("card.rendered",function(a){if("error"===a.name)return g("Cannot create a card for the url. Please check the URL you entered is correct."),!0;f.send("card.snippet")})):g("Cannot create a card for the url. Please check the URL you entered is correct.");return!1}function l(b){b&&!1!==a.events.trigger("embedly.beforeRemove",[b])&&(a.popups.hideAll(),a.toolbar.enable(),a.selection.setBefore(b.get(0))||a.selection.setAfter(b.get(0)),b.remove(),a.selection.restore(),a.html.fillEmptyBlocks(!0),a.events.trigger("embedly.removed",[b]))}return{_init:function(){a.events.on("keydown",function(b,d){var c,f=e(a.selection.element());f&&f.hasClass("embedly-card-area")&&(c=f);f=b.which;if(c&&(f==e.FroalaEditor.KEYCODE.BACKSPACE||f==e.FroalaEditor.KEYCODE.DELETE))return b.preventDefault(),l(c),!1;if(c&&!a.keys.ctrlKey(b))return b.preventDefault(),!1},!0);a.events.on("keydown",function(){a.$el.find("span.embedly-card-area:empty").remove()})},showPopup:function(){if(!a.popups.get("embedly.insert")){var b="";a.opts.popupButtons&&0<a.opts.popupButtons.length&&(b=b+'<div class="fr-buttons">'+a.button.buildList(a.opts.popupButtons),b+="</div>");var d=0,c='<div class="fr-link-insert-layer fr-layer fr-active" id="fr-link-insert-layer-'+a.id+'">',c=c+'<ul class="errorlist" style="display:none;"></ul>';a.opts.embedlyHelpText&&(c+='<span class="fr-small-text">'+a.language.translate(a.opts.embedlyHelpText)+"</span>");c+='<div class="fr-input-line"><input name="href" type="text" class="fr-link-attr" placeholder="URL" tabIndex="'+ ++d+'"></div>';c+='<div class="fr-action-buttons"><button class="fr-command fr-submit" data-cmd="linkEmbedlyInsert" href="#" tabIndex="'+ ++d+'" type="button">'+a.language.translate("Insert")+"</button></div></div>";a.popups.create("embedly.insert",{buttons:b,input_layer:c})}k();a.popups.setContainer("embedly.insert",a.$tb);b=a.$tb.find('.fr-command[data-cmd="embedlyBtn"]');d=b.offset().left+b.outerWidth()/2;c=b.offset().top+(a.opts.toolbarBottom?10:b.outerHeight()-10);a.popups.show("embedly.insert",d,c,b.outerHeight())},hidePopup:function(){a.popups.hide("embedly.insert")},insertCallback:function(){var b=a.popups.get("embedly.insert").find('input.fr-link-attr[type="text"][name="href"]').val(),d=e(a.original_window).scrollTop();m(b);e(a.original_window).scrollTop(d)},resetPopup:k,remove:l}};e.FroalaEditor.DefineIcon("embedlyBtnIcon",{NAME:"code"});e.FroalaEditor.RegisterCommand("embedlyBtn",{title:"Embed",icon:"embedlyBtnIcon",undo:!1,focus:!0,popup:!0,refreshOnCallback:!1,callback:function(){this.popups.isVisible("embedly.insert")?(this.$el.find(".fr-marker")&&(this.events.disableBlur(),this.selection.restore()),this.popups.hide("embedly.insert")):this.embedly.showPopup()}});e.FroalaEditor.RegisterCommand("linkEmbedlyInsert",{focus:!1,refreshAfterCallback:!1,callback:function(){this.embedly.insertCallback()}})});